# 通用爬虫使用指南

## 📁 核心文件

### 1. `backend/generic_crawler.py` - 生产环境爬虫
**用途**：正式爬取任务使用
**特点**：
- 模块化设计（配置管理、HTML解析、HTTP请求分离）
- 支持多线程并发
- Redis缓存（避免重复下载）
- 进度回调和日志回调
- 支持代理

### 2. `backend/generic_crawler_debug.py` - PyCharm调试工具
**用途**：在 PyCharm 中测试和调试配置文件
**特点**：
- 继承自 `GenericNovelCrawler`，添加调试信息
- 详细显示每个解析步骤
- 显示匹配状态和上下文
- 直接修改配置参数，无需命令行

## 🚀 快速开始

### 生产使用

```python
from backend.generic_crawler import GenericNovelCrawler

crawler = GenericNovelCrawler(
    config_file="configs/config_ikbook8.json",
    book_id="10683",
    max_workers=5,
    use_proxy=False
)

crawler.run()
```

### PyCharm 调试

1. **打开文件**：`backend/generic_crawler_debug.py`

2. **修改配置**（文件末尾）：
```python
CONFIG_FILE = project_root / "configs" / "config_ikbook8.json"
BOOK_ID = "10683"
TEST_CHAPTER_INDEX = 0
```

3. **运行或调试**：右键 → Run/Debug

## 🔍 调试工具特性

### 输出内容

#### 1. 小说信息解析
```
📊 解析结果:
  title: 《洪荒：我的老婆是后土》
  author: 西游向往

🔍 调试详情:
  字段: author
    原始值: 作  者：西游向往
    最终值: 西游向往
    后处理步骤:
      步骤1: replace
        匹配: ✅
        变化: 是
```

#### 2. 章节列表解析
```
✅ 解析成功，共 47 章

前5章预览:
  1. 第一章 我的老婆是后土
     URL: https://...
```

#### 3. 章节内容解析
```
📊 内容统计:
  处理页数: 2
  原始长度: 3000 字
  最终长度: 2842 字

🧹 清理步骤:
  规则1: replace
    匹配: ✅ (精确匹配)
    变化: ✅
    匹配上下文:
      替换前: ...广告内容...
      替换后: ......
```

### 匹配状态说明

- **✅ 精确匹配**：直接找到并替换
- **✅ 智能匹配**：通过空格标准化后匹配
- **❌ 未匹配**：没有找到要替换的内容

## 📝 配置文件示例

```json
{
  "site_info": {
    "name": "ikbook8",
    "base_url": "https://m.ikbook8.com"
  },
  "url_patterns": {
    "book_detail": "/book/{0}.html"
  },
  "parsers": {
    "novel_info": {
      "title": {
        "type": "xpath",
        "expression": "//div[@class='info']//p[1]/text()",
        "index": 0
      },
      "author": {
        "type": "xpath",
        "expression": "//div[@class='info']//p[1]/text()",
        "index": -1,
        "process": [
          {
            "method": "replace",
            "params": {"old": "作  者：", "new": ""}
          }
        ]
      }
    },
    "chapter_list": {
      "items": {
        "type": "xpath",
        "expression": "//div[@class='section-box'][last()]/ul/li"
      },
      "title": {
        "type": "xpath",
        "expression": "./a/text()"
      },
      "url": {
        "type": "xpath",
        "expression": "./a/@href"
      }
    },
    "chapter_content": {
      "content": {
        "type": "xpath",
        "expression": "//div[@class='content'][last()]//text()",
        "index": 999,
        "process": [
          {
            "method": "join",
            "params": {"separator": "\n"}
          }
        ]
      },
      "clean": [
        {
          "method": "replace",
          "params": {"old": "广告内容", "new": ""}
        }
      ]
    }
  }
}
```

## 🛠️ 支持的后处理方法

| 方法 | 说明 | 参数 |
|------|------|------|
| `strip` | 去除首尾空白 | `chars`: 要去除的字符 |
| `replace` | 字符串替换 | `old`, `new` |
| `regex_replace` | 正则替换 | `pattern`, `repl` |
| `join` | 连接列表 | `separator` |
| `split` | 分割字符串 | `separator` |
| `extract_first` | 提取第一个元素 | 无 |
| `extract_index` | 提取指定索引 | `index` |

## 🐛 常见问题

### Q: 内容为空？
**原因**：XPath表达式不匹配
**解决**：
1. 运行 `generic_crawler_debug.py`
2. 查看"匹配"状态
3. 如果显示 ❌，调整配置文件中的XPath

### Q: 清理规则不生效？
**原因**：没有找到要替换的内容
**解决**：
1. 查看"匹配上下文"
2. 确认 `old` 参数与实际内容一致
3. 注意空格类型（普通空格 vs `\xa0`）

### Q: 如何测试特定章节？
**方法**：
```python
# 在 generic_crawler_debug.py 中修改
TEST_CHAPTER_INDEX = 9  # 测试第10章
```

## 💡 最佳实践

1. **先调试后部署**：
   - 使用 `generic_crawler_debug.py` 测试配置
   - 确认所有解析正确后再正式爬取

2. **合理设置并发**：
   - 调试时：`MAX_WORKERS = 1`
   - 正式爬取：根据网站情况调整（建议3-10）

3. **使用代理**：
   - 大量爬取时启用代理避免IP封禁
   - `use_proxy=True`

4. **监控Redis统计**：
   - 定期检查成功/失败章节数
   - 失败章节可以重试

## 📂 项目结构

```
backend/
  ├── generic_crawler.py         # 核心爬虫
  ├── generic_crawler_debug.py   # 调试工具
  ├── config_manager.py           # 配置管理
  ├── parser.py                   # HTML解析
  └── content_fetcher.py          # HTTP请求

configs/
  ├── config_template.json        # 配置模板
  └── config_*.json               # 各网站配置

docs/
  ├── 通用爬虫使用指南.md         # 本文档
  └── 调试工具使用.md             # 快速参考
```

## 🔗 相关文档

- [调试工具快速参考](./调试工具使用.md)
- [配置文件模板](../configs/config_template.json)

---

**更新日期**: 2025-10-05  
**版本**: 2.0

