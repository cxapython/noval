# 爬虫代码生成功能说明

## 功能概述

新增了**爬虫代码生成功能**，允许用户基于已保存的配置文件生成独立的Python爬虫代码，方便下载到本地进行测试和部署。

## 主要特性

### 1. 自动代码生成
- 基于配置文件自动生成完整的Python爬虫类
- 包含命令行参数解析
- 支持自定义并发数和代理设置
- 生成的代码完全可独立运行

### 2. 代码编辑器
- 使用Monaco Editor提供专业的代码编辑体验
- 支持Python语法高亮
- 代码自动补全
- 快捷键支持（Ctrl+S保存、Ctrl+/注释、Alt+Shift+F格式化）

### 3. 两种使用方式

#### 方式一：通过配置向导（ConfigWizard）
1. 进入配置向导创建新配置
2. 完成三个步骤的字段配置
3. 在第四步"配置预览"页面，点击**"保存配置"**按钮
4. 配置保存成功后，会出现**"生成爬虫代码"**按钮
5. 点击按钮，系统自动生成代码并在编辑器中打开
6. 可以在编辑器中修改代码，然后点击**"保存到文件"**

#### 方式二：通过爬虫管理页面（CrawlerManager）
1. 进入爬虫配置管理页面
2. 在配置卡片底部找到**"生成代码"**按钮
3. 点击按钮确认生成
4. 代码在编辑器中打开，可编辑后保存

## 生成的代码结构

生成的爬虫代码包含以下部分：

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
{site_name} 小说爬虫 - 基于通用爬虫框架
自动生成于配置管理器
"""

class {SiteName}Crawler:
    """爬虫类，封装了配置加载和执行逻辑"""
    
    def __init__(self, book_id, max_workers=5, use_proxy=False):
        """初始化爬虫"""
        
    def run(self):
        """运行爬虫"""

def main():
    """命令行入口，支持参数解析"""
    
if __name__ == '__main__':
    main()
```

## 使用生成的代码

### 1. 保存代码
点击编辑器中的"保存到文件"按钮，代码会保存到项目根目录，文件名格式：`{site_name}_crawler.py`

### 2. 运行代码

#### 基本用法
```bash
python ikbook8_crawler.py 12345
```

#### 使用代理
```bash
python ikbook8_crawler.py 12345 --proxy
```

#### 指定并发数
```bash
python ikbook8_crawler.py 12345 --workers 10
```

#### 组合使用
```bash
python ikbook8_crawler.py 12345 --proxy --workers 10
```

### 3. 查看帮助
```bash
python ikbook8_crawler.py --help
```

## 代码特点

1. **完全独立**：生成的代码可以单独运行，只需要配置文件
2. **易于定制**：代码结构清晰，可以根据需要修改
3. **兼容性好**：支持Python 3.8+
4. **错误处理**：包含完整的异常处理逻辑
5. **日志输出**：使用loguru提供详细的运行日志

## API端点

### 生成代码
```
POST /api/crawler/generate-crawler/{filename}
```

**响应**：
```json
{
  "success": true,
  "message": "爬虫代码已生成",
  "filename": "ikbook8_crawler.py",
  "content": "#!/usr/bin/env python3\n..."
}
```

### 保存代码
```
POST /api/crawler/save-crawler
```

**请求体**：
```json
{
  "filename": "ikbook8_crawler.py",
  "content": "#!/usr/bin/env python3\n..."
}
```

**响应**：
```json
{
  "success": true,
  "message": "爬虫代码已保存到: ikbook8_crawler.py",
  "path": "/path/to/ikbook8_crawler.py"
}
```

## 测试

运行测试脚本：
```bash
python tests/test_code_generation.py
```

测试脚本会：
1. 获取配置列表
2. 生成爬虫代码
3. 验证代码内容
4. 测试保存功能
5. 清理测试文件

## 技术实现

### 前端组件
- **CodeEditor.jsx**：Monaco Editor封装，提供代码编辑功能
- **ConfigPreview.jsx**：配置预览组件，集成代码生成按钮
- **CrawlerManager.jsx**：配置管理页面，添加生成代码入口

### 后端API
- **generate_crawler_code()**：代码生成函数，使用模板生成Python代码
- **/generate-crawler/<filename>**：生成代码的API端点
- **/save-crawler**：保存代码的API端点

## 注意事项

1. **配置文件依赖**：生成的爬虫代码依赖对应的配置文件，请确保配置文件存在于`configs/`目录
2. **文件位置**：保存的代码文件默认在项目根目录，可以移动到其他位置
3. **配置路径**：如果移动代码文件，需要修改代码中的`config_path`指向正确的配置文件位置
4. **依赖安装**：确保已安装所有必要的Python依赖（见`requirements.txt`）

## 常见问题

**Q: 生成的代码可以在其他机器上运行吗？**  
A: 可以，只需要将代码文件、配置文件和`backend/`目录复制到目标机器，并安装依赖即可。

**Q: 如何修改生成的代码？**  
A: 在代码编辑器中直接修改，或保存后用任何文本编辑器打开修改。

**Q: 生成代码失败怎么办？**  
A: 检查配置文件是否完整，后端服务是否正常运行，查看控制台错误日志。

**Q: 可以批量生成多个配置的代码吗？**  
A: 目前需要逐个生成，可以通过配置管理页面快速操作。

## 更新日志

### 2025-10-08
- ✅ 创建CodeEditor组件（使用Mantine + Monaco Editor）
- ✅ 在ConfigPreview组件中添加生成代码按钮和功能
- ✅ 在CrawlerManager组件中添加生成代码功能
- ✅ 创建测试脚本验证功能
- ✅ 编写功能说明文档

## 相关文件

- `/frontend/src/components/CodeEditor.jsx` - 代码编辑器组件
- `/frontend/src/pages/ConfigWizard/ConfigPreview.jsx` - 配置预览组件
- `/frontend/src/pages/CrawlerManager.jsx` - 配置管理页面
- `/backend/routes/crawler.py` - 后端API实现
- `/tests/test_code_generation.py` - 测试脚本

