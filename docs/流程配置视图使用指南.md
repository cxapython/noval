# 🎨 流程配置视图使用指南

> 通过可视化拖拽的方式配置爬虫规则，零代码生成JSON配置

---

## 🚀 快速开始

### 1. 安装依赖

```bash
cd /Users/chennan/pythonproject/demo/noval/frontend
npm install reactflow
```

### 2. 启动前端

```bash
npm run dev
```

### 3. 访问流程配置

1. 打开浏览器访问前端页面
2. 进入 **爬虫管理** → **新建配置** 或 **编辑配置**
3. 点击 **流程配置** Tab（第2个Tab，带有树形图标 🌲）

---

## 📖 使用流程

### 第一步：拖拽组件

从左侧 **组件面板** 拖拽组件到中间画布：

```
📍 提取器
  ├─ XPath提取    - 使用XPath从HTML提取数据
  └─ 正则提取     - 使用正则表达式提取文本

🧹 清洗器
  ├─ 去除空格     - 去除首尾空白字符
  ├─ 字符替换     - 替换指定字符串
  ├─ 正则替换     - 正则表达式替换
  ├─ 合并数组     - 将数组元素连接成字符串
  ├─ 分割字符串   - 将字符串分割成数组
  ├─ 提取第一个   - 从数组提取第一个元素
  └─ 提取指定索引 - 从数组提取指定位置元素
```

### 第二步：连接节点

从节点 **右侧的圆点** 拖动到下一个节点的 **左侧圆点**，建立数据流向。

**规则：**
- 起点必须是提取器（XPath或正则）
- 提取器后面可以连接多个清洗器
- 数据从左到右流动

### 第三步：配置参数

点击节点，直接在卡片中填写参数：

#### XPath提取器
- **XPath表达式**：例如 `//div[@class='content']//text()`
- **索引位置**：
  - `0` - 第1个
  - `-1` - 最后1个
  - `999` - 全部

#### 清洗器参数
不同的清洗器有不同的参数，界面会自动显示对应的输入框。

### 第四步：生成配置

1. 点击画布上方的 **生成配置** 按钮
2. 系统会验证流程是否有效
3. 预览生成的JSON配置
4. 点击 **应用到配置** 将配置合并到主配置中

### 第五步：保存和运行

1. 切换到 **JSON视图** 查看完整配置
2. 点击 **保存配置** 按钮
3. 输入文件名（如 `config_mysite.json`）
4. 返回 **爬虫管理** 页面，选择保存的配置文件
5. 输入书籍ID，点击 **运行**

---

## 💡 示例：配置章节内容提取

### 目标
提取小说章节内容，并清洗掉广告文本

### 流程设计

```
XPath提取 → 合并数组 → 字符替换 → 去除空格
```

### 详细步骤

#### 1. 添加 XPath提取器

拖拽 **XPath提取** 到画布

配置：
- **表达式**：`//div[@class='content']//text()`
- **索引**：`999`（全部）

#### 2. 添加 合并数组

拖拽 **合并数组** 到画布右侧

配置：
- **分隔符**：`\n`（换行符）

连接：XPath提取器 → 合并数组

#### 3. 添加 字符替换

拖拽 **字符替换** 到画布

配置：
- **原字符串**：`『加入书签，方便阅读』`
- **新字符串**：（留空表示删除）

连接：合并数组 → 字符替换

#### 4. 添加 去除空格

拖拽 **去除空格** 到画布

无需配置参数

连接：字符替换 → 去除空格

#### 5. 生成配置

点击 **生成配置**，将得到：

```json
{
  "type": "xpath",
  "expression": "//div[@class='content']//text()",
  "index": 999,
  "process": [
    {
      "method": "join",
      "params": { "separator": "\n" }
    },
    {
      "method": "replace",
      "params": { "old": "『加入书签，方便阅读』", "new": "" }
    },
    {
      "method": "strip",
      "params": {}
    }
  ]
}
```

---

## 🎯 高级技巧

### 技巧1：多个替换连用

如果要删除多个广告文本，可以连续使用多个 **字符替换** 节点：

```
提取器 → 合并 → 替换1 → 替换2 → 替换3 → 去空格
```

### 技巧2：正则清洗

使用 **正则替换** 清除模式化的广告：

```
提取器 → 合并 → 正则替换 → 去空格
```

正则替换配置：
- **正则表达式**：`第\d+章.*?阅读模式`
- **替换文本**：（留空）

### 技巧3：验证流程

在生成配置前，系统会自动验证：
- ✅ 是否有提取器节点
- ✅ 提取器是否配置了表达式
- ✅ 处理器参数是否完整
- ✅ 是否有悬空节点

### 技巧4：画布操作

- **缩放**：鼠标滚轮
- **平移**：鼠标拖动空白区域
- **删除节点**：选中节点按 `Delete` 或 `Backspace`
- **删除连线**：点击连线选中后按 `Delete`

---

## 🔧 配置结构说明

### 完整配置结构

流程配置生成的是字段级别的配置，最终会合并到完整配置的 `parsers` 部分：

```json
{
  "site_info": { ... },
  "url_templates": { ... },
  "request_config": { ... },
  "crawler_config": { ... },
  "parsers": {
    "novel_info": {
      "title": { ... },
      "author": { ... }
    },
    "chapter_list": {
      "items": { ... },
      "title": { ... },
      "url": { ... }
    },
    "chapter_content": {
      "content": {
        // 这里是流程配置生成的部分 👇
        "type": "xpath",
        "expression": "...",
        "index": 999,
        "process": [ ... ]
      }
    }
  }
}
```

### 当前版本支持的字段

流程配置目前主要用于配置 **单个字段**，推荐用于：
- `parsers.chapter_content.content` - 章节内容
- `parsers.novel_info.title` - 小说标题
- `parsers.novel_info.author` - 作者
- `parsers.chapter_list.title` - 章节标题

---

## 🆚 对比传统方式

### 传统方式（JSON编辑）

```json
{
  "type": "xpath",
  "expression": "//div[@class='content']//text()",
  "index": 999,
  "process": [
    {"method": "join", "params": {"separator": "\n"}},
    {"method": "replace", "params": {"old": "广告", "new": ""}},
    {"method": "strip", "params": {}}
  ]
}
```

**缺点：**
- ❌ 需要手写JSON
- ❌ 容易出错（语法、逗号、引号）
- ❌ 不直观，看不出流程
- ❌ 难以调试

### 流程配置方式

**优点：**
- ✅ 可视化拖拽，零代码
- ✅ 自动生成正确的JSON
- ✅ 流程清晰，一目了然
- ✅ 实时验证，减少错误
- ✅ 快速调整，拖拽即改

---

## 🐛 常见问题

### Q1: 提示"缺少提取器节点"
**A:** 必须先添加一个XPath或正则提取器作为起点。

### Q2: 生成配置后在哪里查看？
**A:** 点击"应用到配置"后，切换到 **JSON视图** 查看完整配置。

### Q3: 能否保存流程模板？
**A:** 当前版本暂不支持，但计划在下一版本添加。保存配置文件后，可以重新加载该配置。

### Q4: 如何配置多个字段？
**A:** 当前版本流程配置主要用于单个字段。建议：
- 章节内容用流程配置
- 其他字段用表单视图

### Q5: 生成的配置可以手动修改吗？
**A:** 可以！应用到配置后，切换到JSON视图手动调整。

### Q6: 连线连错了怎么办？
**A:** 点击连线选中后，按 `Delete` 键删除，重新连接。

---

## 🔮 未来规划

### 即将支持的功能

- [ ] **多字段流程编辑**：在一个画布上同时配置多个字段
- [ ] **流程模板库**：预设常见网站的提取流程
- [ ] **自定义插件节点**：上传自己的清洗插件
- [ ] **流程导入导出**：保存和分享流程图
- [ ] **实时测试**：在画布上直接测试每个节点的输出
- [ ] **智能推荐**：根据URL自动推荐节点组合
- [ ] **撤销/重做**：支持Ctrl+Z/Ctrl+Y
- [ ] **批量操作**：复制、粘贴、对齐节点

---

## 📚 相关文档

- [插件化流程编辑器TODO](./插件化流程编辑器TODO.md)
- [插件化改造快速指南](./插件化改造快速指南.md)
- [清洗规则统一说明](./清洗规则统一说明.md)

---

## 💬 反馈和建议

如有问题或建议，欢迎反馈！

**祝你配置愉快！** 🎉
