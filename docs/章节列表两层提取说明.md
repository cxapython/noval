# 📖 章节列表两层提取架构说明

## 🎯 核心概念

章节列表使用**两层提取架构**：
1. **第1层（items）**：批量选择所有章节容器
2. **第2层（title/url）**：在每个容器内提取数据

## 📋 HTML结构示例

假设网页HTML结构如下：

```html
<div class="chapter-box">
  <ul class="chapter-list">
    <li class="chapter-item">
      <a href="/chapter/1.html">第一章 开始</a>
    </li>
    <li class="chapter-item">
      <a href="/chapter/2.html">第二章 修炼</a>
    </li>
    <li class="chapter-item">
      <a href="/chapter/3.html">第三章 突破</a>
    </li>
  </ul>
</div>
```

## ⚙️ 配置示例

### 完整配置

```json
{
  "chapter_list": {
    "items": {
      "expression": "//ul[@class='chapter-list']/li",
      "type": "xpath"
    },
    "title": {
      "expression": "./a/text()",
      "type": "xpath",
      "process": [
        { "method": "strip" }
      ]
    },
    "url": {
      "expression": "./a/@href",
      "type": "xpath"
    }
  }
}
```

### 详细解释

#### 1️⃣ 第一层：items（列表项选择器）

**XPath:** `//ul[@class='chapter-list']/li`

**作用:** 从整个页面选择所有的 `<li>` 元素

**结果:** 返回3个元素
```
[
  <li class="chapter-item">...</li>,
  <li class="chapter-item">...</li>,
  <li class="chapter-item">...</li>
]
```

#### 2️⃣ 第二层：title（章节标题）

**XPath:** `./a/text()`

**说明:**
- **`.`** 表示当前节点（即单个li元素）
- 这是**相对路径**，在每个li内部执行

**对每个li执行:**
- 第1个li: `./a/text()` → "第一章 开始"
- 第2个li: `./a/text()` → "第二章 修炼"  
- 第3个li: `./a/text()` → "第三章 突破"

#### 3️⃣ 第二层：url（章节链接）

**XPath:** `./a/@href`

**说明:**
- `./a/@href` 提取a标签的href属性
- 相对路径，在每个li内部执行

**对每个li执行:**
- 第1个li: `./a/@href` → "/chapter/1.html"
- 第2个li: `./a/@href` → "/chapter/2.html"
- 第3个li: `./a/@href` → "/chapter/3.html"

## 🔄 后端处理流程

```python
# 伪代码展示后端处理逻辑

# 第1层：批量选择
items_xpath = "//ul[@class='chapter-list']/li"
chapter_items = root.xpath(items_xpath)  # 返回所有li元素

chapters = []

# 第2层：对每个容器元素执行提取
for item in chapter_items:
    # 在当前item内部提取title
    title = item.xpath("./a/text()").get()
    
    # 在当前item内部提取url
    url = item.xpath("./a/@href").get()
    
    chapters.append({
        'title': title,
        'url': url
    })

# 结果：
# [
#   {'title': '第一章 开始', 'url': '/chapter/1.html'},
#   {'title': '第二章 修炼', 'url': '/chapter/2.html'},
#   {'title': '第三章 突破', 'url': '/chapter/3.html'}
# ]
```

## 💡 常见场景和示例

### 场景1：标题和链接在同一个标签

```html
<ul>
  <li><a href="/ch1.html">第一章</a></li>
  <li><a href="/ch2.html">第二章</a></li>
</ul>
```

**配置:**
```json
{
  "items": { "expression": "//ul/li" },
  "title": { "expression": "./a/text()" },
  "url": { "expression": "./a/@href" }
}
```

### 场景2：标题和链接分离

```html
<ul>
  <li data-url="/ch1.html">
    <span class="title">第一章</span>
  </li>
  <li data-url="/ch2.html">
    <span class="title">第二章</span>
  </li>
</ul>
```

**配置:**
```json
{
  "items": { "expression": "//ul/li" },
  "title": { "expression": ".//span[@class='title']/text()" },
  "url": { "expression": "./@data-url" }
}
```

### 场景3：嵌套结构

```html
<div class="chapter-box">
  <div class="item">
    <div class="info">
      <h3>第一章 标题</h3>
      <a href="/ch1.html" class="link">阅读</a>
    </div>
  </div>
</div>
```

**配置:**
```json
{
  "items": { "expression": "//div[@class='chapter-box']/div[@class='item']" },
  "title": { "expression": ".//h3/text()" },
  "url": { "expression": ".//a[@class='link']/@href" }
}
```

## ⚠️ 常见错误

### ❌ 错误1：第2层使用绝对路径

```json
{
  "items": { "expression": "//ul/li" },
  "title": { "expression": "//ul/li/a/text()" }  // ❌ 错误！
}
```

**问题:** title使用了绝对路径，会从整个页面查找，而不是在当前item内查找

**正确做法:**
```json
{
  "items": { "expression": "//ul/li" },
  "title": { "expression": "./a/text()" }  // ✅ 正确！使用相对路径
}
```

### ❌ 错误2：忘记 `.` 前缀

```json
{
  "items": { "expression": "//ul/li" },
  "title": { "expression": "a/text()" }  // ❌ 可能有问题
}
```

**说明:** 虽然某些情况下可以工作，但最好明确使用 `./` 表示相对路径

**推荐做法:**
```json
{
  "items": { "expression": "//ul/li" },
  "title": { "expression": "./a/text()" }  // ✅ 推荐
}
```

### ❌ 错误3：items选择过于具体

```json
{
  "items": { "expression": "//ul/li/a" }  // ❌ 不好
}
```

**问题:** items应该选择完整的容器，而不是具体的元素

**正确做法:**
```json
{
  "items": { "expression": "//ul/li" }  // ✅ 正确
}
```

## 🎓 学习建议

1. **查看网页源码**
   - 使用浏览器开发者工具（F12）
   - 找到章节列表的HTML结构
   - 确定容器元素和内部元素

2. **先配置items**
   - 选择能包含标题和链接的最小容器
   - 确保选择到所有章节项

3. **再配置title和url**
   - 在单个容器内测试XPath
   - 使用相对路径（以 `.` 开头）
   - 验证是否能正确提取

4. **使用测试功能**
   - 在配置页面使用"测试"按钮
   - 查看提取结果是否正确
   - 根据结果调整XPath

## 🔗 相关文档

- [XPath语法参考](./XPath语法说明.md)
- [配置向导使用指南](./配置向导使用指南.md)
- [流程编辑器使用指南](./流程配置视图使用指南.md)
