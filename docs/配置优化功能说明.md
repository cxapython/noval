# 爬虫配置优化功能说明

本文档介绍新增的两大配置优化功能：**配置测试/预览** 和 **智能配置向导**

## 📋 目录

1. [功能1：配置测试/预览](#功能1配置测试预览)
2. [功能2：智能配置向导](#功能2智能配置向导)
3. [使用场景](#使用场景)
4. [API接口说明](#api接口说明)

---

## 功能1：配置测试/预览

### 🎯 功能概述

在配置编辑器中实时测试配置是否正确，无需保存和运行爬虫即可验证解析规则。

### 📍 功能位置

爬虫配置管理 → 编辑配置 → **"配置测试"** Tab页

### 🚀 使用步骤

#### 步骤1：打开配置编辑器
- 方式1：编辑现有配置
- 方式2：新建配置

#### 步骤2：切换到"配置测试"Tab

<img src="../screenshots/config-test-tab.png" width="800" alt="配置测试Tab" />

#### 步骤3：输入测试参数
- **测试URL**：输入目标网页地址
  ```
  例如：https://m.ikbook8.com/book/41934.html
  ```
- **测试类型**：选择要测试的配置项
  - 📚 小说信息解析
  - 📑 章节列表解析  
  - 📄 章节内容解析

#### 步骤4：点击"开始测试"

系统会：
1. 使用当前配置抓取指定URL
2. 解析页面内容
3. 显示解析结果

### ✅ 测试结果展示

#### 成功示例：
```json
{
  "type": "小说信息",
  "data": {
    "title": "洪荒：开局斩杀混沌魔神",
    "author": "作者名",
    "cover": "封面URL"
  }
}
```

#### 失败示例：
```
❌ 错误信息：XPath表达式错误
详细堆栈：...
```

### 💡 使用技巧

1. **快速验证XPath**：修改配置后立即测试，无需保存
2. **对比测试**：测试不同的XPath表达式，选择最优方案
3. **调试清理规则**：查看清理前后的内容对比
4. **分步测试**：分别测试小说信息、章节列表、章节内容

---

## 功能2：智能配置向导

### 🎯 功能概述

基于Playwright浏览器引擎，提供可视化页面渲染和智能XPath生成，大幅降低配置门槛。

### 📍 功能位置

爬虫配置管理 → **"智能向导"** 按钮

### 🚀 使用步骤

#### 步骤1：页面渲染

1. 点击"智能向导"按钮
2. 输入目标网页URL
   ```
   例如：https://m.ikbook8.com/book/41934.html
   ```
3. 点击"开始渲染"

**系统会：**
- 使用真实浏览器渲染页面
- 生成完整页面截图
- 提取页面HTML源码

<img src="../screenshots/wizard-step1.png" width="800" alt="步骤1：页面渲染" />

#### 步骤2：元素识别

两种识别方式：

##### 方式1：CSS选择器（推荐）

1. 在浏览器开发者工具中找到目标元素
2. 右键 → Copy → Copy selector
3. 粘贴到"CSS选择器"输入框
4. 点击"生成XPath建议"

**示例：**
```css
div.book-info > h1.title
```

##### 方式2：元素文本

1. 复制元素的文本内容
2. 粘贴到"元素文本"输入框
3. 点击"生成XPath建议"

**示例：**
```
洪荒：开局斩杀混沌魔神
```

#### 步骤3：选择XPath

系统会生成多种XPath建议，按优先级排序：

| 优先级 | 类型 | XPath示例 | 说明 |
|-------|------|-----------|------|
| 1 | 基于ID | `//h1[@id="bookTitle"]` | 最稳定，优先推荐 |
| 2 | 基于完整class | `//h1[@class="title main"]` | 较稳定 |
| 3 | 基于单个class | `//h1[contains(@class, "title")]` | 通用性好 |
| 4 | 基于文本内容 | `//h1[contains(text(), "洪荒")]` | 灵活但可能不唯一 |

**操作：**
- 点击"选择"按钮选中合适的XPath
- 点击"复制"按钮复制XPath到剪贴板
- 点击"下一步"

#### 步骤4：配置应用

1. 复制生成的XPath
2. 点击"前往配置编辑器"
3. 粘贴到对应的配置字段中
4. 保存配置

### 💡 使用技巧

#### 1. 如何获取CSS选择器？

**Chrome/Edge浏览器：**
1. F12打开开发者工具
2. 点击左上角的选择元素工具（Ctrl+Shift+C）
3. 鼠标悬停在目标元素上
4. 右键 → Copy → Copy selector

**Firefox浏览器：**
1. F12打开开发者工具
2. 点击选择元素工具
3. 点击目标元素
4. 右键 → Copy → CSS Selector

#### 2. 选择最佳XPath的原则

- ✅ **优先选择基于ID**：最稳定，不易变化
- ✅ **其次选择基于class**：较稳定，兼容性好
- ⚠️ **谨慎使用文本匹配**：文本内容可能变化
- ❌ **避免使用索引**：页面结构变化会失效

#### 3. 常见问题解决

**Q：XPath生成失败？**
- 检查CSS选择器是否正确
- 尝试使用更简单的选择器
- 使用元素文本方式尝试

**Q：生成的XPath不准确？**
- 在浏览器F12中测试XPath：`$x("你的xpath")`
- 检查是否选中了正确的元素
- 尝试其他优先级的XPath建议

**Q：页面渲染失败？**
- 检查URL是否正确
- 检查网络连接
- 某些网站有反爬措施，可能需要调整headers

---

## 使用场景

### 场景1：新建配置
1. 使用 **智能向导** 渲染页面并生成XPath
2. 复制XPath到配置编辑器
3. 使用 **配置测试** 验证配置正确性
4. 保存配置

### 场景2：调试现有配置
1. 打开配置编辑器
2. 在 **配置测试** Tab测试各个解析器
3. 发现问题后修改配置
4. 再次测试验证

### 场景3：批量适配网站
1. 使用智能向导快速生成多个字段的XPath
2. 一次性复制到配置中
3. 批量测试所有字段
4. 优化调整

---

## API接口说明

### 1. 测试单个解析器

**接口：** `POST /api/crawler/test-parser`

**请求参数：**
```json
{
  "url": "https://example.com/book/123.html",
  "parser_config": {
    "type": "xpath",
    "expression": "//h1[@class='title']/text()",
    "index": 0
  },
  "request_config": {
    "headers": {...},
    "timeout": 30,
    "encoding": "utf-8"
  }
}
```

**响应示例：**
```json
{
  "success": true,
  "result": "洪荒：开局斩杀混沌魔神",
  "result_info": "字符串类型，长度15",
  "html_preview": "...",
  "html_length": 12345
}
```

### 2. 测试完整配置

**接口：** `POST /api/crawler/test-config`

**请求参数：**
```json
{
  "url": "https://example.com/book/123.html",
  "config": {...},
  "test_type": "novel_info"  // 或 chapter_list、chapter_content
}
```

**响应示例：**
```json
{
  "success": true,
  "results": {
    "type": "小说信息",
    "data": {
      "title": "...",
      "author": "...",
      "cover": "..."
    }
  }
}
```

### 3. 渲染页面

**接口：** `POST /api/crawler/render-page`

**请求参数：**
```json
{
  "url": "https://example.com/book/123.html"
}
```

**响应示例：**
```json
{
  "success": true,
  "title": "页面标题",
  "html": "...",
  "html_length": 50000,
  "screenshot": "data:image/png;base64,..."
}
```

### 4. 生成XPath

**接口：** `POST /api/crawler/generate-xpath`

**请求参数：**
```json
{
  "url": "https://example.com/book/123.html",
  "selector": "div.book-info > h1",
  "element_text": "书名"
}
```

**响应示例：**
```json
{
  "success": true,
  "suggestions": [
    {
      "xpath": "//h1[@id='bookTitle']",
      "type": "基于ID",
      "priority": 1
    },
    {
      "xpath": "//h1[@class='title']",
      "type": "基于完整class",
      "priority": 2
    }
  ]
}
```

---

## 📊 功能对比

| 功能 | 配置测试 | 智能向导 |
|------|---------|---------|
| 主要用途 | 验证配置正确性 | 生成配置 |
| 使用时机 | 编辑配置时 | 新建配置时 |
| 技术依赖 | 通用爬虫引擎 | Playwright |
| 输入 | 配置+URL | URL+选择器 |
| 输出 | 解析结果 | XPath建议 |
| 难度 | ⭐⭐ | ⭐ |

---

## 🎉 总结

这两个功能显著提升了爬虫配置的效率和用户体验：

1. **降低门槛**：新手也能通过智能向导快速上手
2. **提高效率**：即时测试反馈，无需反复运行爬虫
3. **减少错误**：可视化操作，减少手动编写XPath的错误
4. **优化体验**：步骤清晰，引导明确

**建议工作流程：**
```
智能向导生成XPath → 配置编辑器填写 → 配置测试验证 → 保存运行
```

---

## 📝 更新日志

- **2025-10-05**：首次发布
  - ✅ 完成配置测试/预览功能
  - ✅ 完成智能配置向导功能
  - ✅ 支持三种测试类型
  - ✅ 支持多种XPath生成策略

---

## 🔗 相关文档

- [快速开始](../快速开始.md)
- [功能说明](../功能说明.md)
- [项目说明](../项目说明.md)
- [API文档](./API文档.md)

