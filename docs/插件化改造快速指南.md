# ğŸš€ æ’ä»¶åŒ–æ”¹é€ å¿«é€ŸæŒ‡å—

> ä»å½“å‰ç³»ç»Ÿå¹³æ»‘å‡çº§åˆ°æ’ä»¶åŒ–+å¯è§†åŒ–æµç¨‹ç¼–è¾‘å™¨

## ğŸ“Œ ç¬¬ä¸€æ­¥ï¼šåç«¯æ’ä»¶åŒ–ï¼ˆä»Šå¤©å®Œæˆï¼‰

### 1.1 åˆ›å»ºæ’ä»¶ç›®å½•ç»“æ„

```bash
cd /Users/chennan/pythonproject/demo/noval/backend
mkdir -p plugins/custom
touch plugins/__init__.py
touch plugins/base.py
touch plugins/builtin.py
touch plugins/custom/__init__.py
```

### 1.2 åˆ›å»ºæ’ä»¶åŸºç±»ï¼ˆbackend/plugins/base.pyï¼‰

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æ’ä»¶ç³»ç»ŸåŸºç¡€æ¶æ„
"""
from typing import Any, Dict, List
from loguru import logger


class ProcessorPlugin:
    """æ¸…æ´—è§„åˆ™æ’ä»¶åŸºç±»"""
    
    category = 'processor'  # æ’ä»¶åˆ†ç±»ï¼šprocessor, extractor, validator
    description = ''        # æ’ä»¶æè¿°
    
    def process(self, data: Any, params: Dict) -> Any:
        """
        å¤„ç†æ•°æ®
        :param data: è¾“å…¥æ•°æ®
        :param params: å‚æ•°é…ç½®
        :return: å¤„ç†åçš„æ•°æ®
        """
        raise NotImplementedError
    
    def validate_params(self, params: Dict) -> bool:
        """
        éªŒè¯å‚æ•°æ˜¯å¦åˆæ³•ï¼ˆå¯é€‰é‡å†™ï¼‰
        :param params: å‚æ•°é…ç½®
        :return: æ˜¯å¦åˆæ³•
        """
        return True


class PluginRegistry:
    """æ’ä»¶æ³¨å†Œå™¨ - ç®¡ç†æ‰€æœ‰æ’ä»¶"""
    
    _plugins: Dict[str, ProcessorPlugin] = {}
    
    @classmethod
    def register(cls, name: str):
        """
        è£…é¥°å™¨ï¼šæ³¨å†Œæ’ä»¶
        
        ç”¨æ³•ï¼š
        @PluginRegistry.register('my_processor')
        class MyProcessor(ProcessorPlugin):
            pass
        """
        def decorator(plugin_class):
            try:
                instance = plugin_class()
                cls._plugins[name] = instance
                logger.debug(f"âœ… æ³¨å†Œæ’ä»¶: {name} ({plugin_class.__name__})")
            except Exception as e:
                logger.error(f"âŒ æ’ä»¶æ³¨å†Œå¤±è´¥ {name}: {e}")
            return plugin_class
        return decorator
    
    @classmethod
    def get(cls, name: str) -> ProcessorPlugin:
        """è·å–æ’ä»¶å®ä¾‹"""
        return cls._plugins.get(name)
    
    @classmethod
    def list_all(cls) -> List[str]:
        """åˆ—å‡ºæ‰€æœ‰å·²æ³¨å†Œæ’ä»¶åç§°"""
        return list(cls._plugins.keys())
    
    @classmethod
    def get_plugin_info(cls, name: str) -> Dict:
        """è·å–æ’ä»¶è¯¦ç»†ä¿¡æ¯"""
        plugin = cls._plugins.get(name)
        if not plugin:
            return None
        
        return {
            'name': name,
            'category': plugin.category,
            'description': plugin.description or plugin.__class__.__doc__ or '',
            'class_name': plugin.__class__.__name__
        }
    
    @classmethod
    def list_by_category(cls, category: str = None) -> Dict:
        """æŒ‰åˆ†ç±»åˆ—å‡ºæ’ä»¶"""
        if category:
            return {
                name: plugin for name, plugin in cls._plugins.items()
                if plugin.category == category
            }
        
        # æŒ‰åˆ†ç±»åˆ†ç»„
        result = {}
        for name, plugin in cls._plugins.items():
            cat = plugin.category
            if cat not in result:
                result[cat] = {}
            result[cat][name] = plugin
        
        return result
```

### 1.3 è¿ç§»å†…ç½®æ’ä»¶ï¼ˆbackend/plugins/builtin.pyï¼‰

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
å†…ç½®æ¸…æ´—è§„åˆ™æ’ä»¶
"""
import re
from typing import Any, Dict, List
from loguru import logger
from .base import ProcessorPlugin, PluginRegistry


@PluginRegistry.register('strip')
class StripProcessor(ProcessorPlugin):
    """å»é™¤é¦–å°¾ç©ºç™½å­—ç¬¦"""
    
    category = 'processor'
    description = 'å»é™¤å­—ç¬¦ä¸²é¦–å°¾çš„ç©ºç™½å­—ç¬¦ï¼ˆç©ºæ ¼ã€åˆ¶è¡¨ç¬¦ã€æ¢è¡Œç¬¦ç­‰ï¼‰'
    
    def process(self, data: Any, params: Dict) -> Any:
        chars = params.get('chars', None)
        
        if isinstance(data, str):
            return data.strip(chars)
        elif isinstance(data, list):
            return [item.strip(chars) if isinstance(item, str) else item for item in data]
        
        return data


@PluginRegistry.register('replace')
class ReplaceProcessor(ProcessorPlugin):
    """å­—ç¬¦ä¸²æ›¿æ¢"""
    
    category = 'processor'
    description = 'å°†å­—ç¬¦ä¸²ä¸­çš„æŒ‡å®šå†…å®¹æ›¿æ¢ä¸ºæ–°å†…å®¹'
    
    def process(self, data: Any, params: Dict) -> Any:
        old = params.get('old', '')
        new = params.get('new', '')
        
        if isinstance(data, str):
            # æ™ºèƒ½å¤„ç†ï¼šå…¼å®¹æ™®é€šç©ºæ ¼å’Œ\xa0ï¼ˆä¸é—´æ–­ç©ºæ ¼ï¼‰
            if old in data:
                return data.replace(old, new)
            else:
                normalized_data = data.replace('\xa0', ' ')
                normalized_old = old.replace('\xa0', ' ')
                if normalized_old in normalized_data:
                    return normalized_data.replace(normalized_old, new)
            return data
        elif isinstance(data, list):
            return [item.replace(old, new) if isinstance(item, str) else item for item in data]
        
        return data
    
    def validate_params(self, params: Dict) -> bool:
        return 'old' in params and 'new' in params


@PluginRegistry.register('regex_replace')
class RegexReplaceProcessor(ProcessorPlugin):
    """æ­£åˆ™è¡¨è¾¾å¼æ›¿æ¢"""
    
    category = 'processor'
    description = 'ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…å¹¶æ›¿æ¢å­—ç¬¦ä¸²å†…å®¹'
    
    def process(self, data: Any, params: Dict) -> Any:
        pattern = params.get('pattern', '')
        repl = params.get('repl', '')
        
        if isinstance(data, str):
            return re.sub(pattern, repl, data)
        elif isinstance(data, list):
            return [re.sub(pattern, repl, item) if isinstance(item, str) else item for item in data]
        
        return data
    
    def validate_params(self, params: Dict) -> bool:
        if 'pattern' not in params:
            return False
        try:
            re.compile(params['pattern'])
            return True
        except re.error:
            return False


@PluginRegistry.register('join')
class JoinProcessor(ProcessorPlugin):
    """æ•°ç»„å…ƒç´ è¿æ¥ä¸ºå­—ç¬¦ä¸²"""
    
    category = 'processor'
    description = 'å°†æ•°ç»„å…ƒç´ ç”¨æŒ‡å®šåˆ†éš”ç¬¦è¿æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²'
    
    def process(self, data: Any, params: Dict) -> Any:
        if isinstance(data, list):
            separator = params.get('separator', '')
            return separator.join([str(item) for item in data])
        return data


@PluginRegistry.register('split')
class SplitProcessor(ProcessorPlugin):
    """å­—ç¬¦ä¸²åˆ†å‰²ä¸ºæ•°ç»„"""
    
    category = 'processor'
    description = 'å°†å­—ç¬¦ä¸²æŒ‰æŒ‡å®šåˆ†éš”ç¬¦åˆ†å‰²æˆæ•°ç»„'
    
    def process(self, data: Any, params: Dict) -> Any:
        if isinstance(data, str):
            separator = params.get('separator', ' ')
            return data.split(separator)
        return data


@PluginRegistry.register('extract_first')
class ExtractFirstProcessor(ProcessorPlugin):
    """æå–æ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ """
    
    category = 'processor'
    description = 'ä»æ•°ç»„ä¸­æå–ç¬¬ä¸€ä¸ªå…ƒç´ '
    
    def process(self, data: Any, params: Dict) -> Any:
        if isinstance(data, list) and len(data) > 0:
            return data[0]
        return data


@PluginRegistry.register('extract_index')
class ExtractIndexProcessor(ProcessorPlugin):
    """æå–æ•°ç»„æŒ‡å®šç´¢å¼•çš„å…ƒç´ """
    
    category = 'processor'
    description = 'ä»æ•°ç»„ä¸­æå–æŒ‡å®šç´¢å¼•ä½ç½®çš„å…ƒç´ '
    
    def process(self, data: Any, params: Dict) -> Any:
        if isinstance(data, list):
            idx = params.get('index', 0)
            try:
                return data[idx]
            except IndexError:
                logger.warning(f"ç´¢å¼• {idx} è¶…å‡ºèŒƒå›´ (æ•°ç»„é•¿åº¦: {len(data)})")
                return None
        return data
    
    def validate_params(self, params: Dict) -> bool:
        return 'index' in params and isinstance(params['index'], int)


# å¯¼å‡ºæ‰€æœ‰æ’ä»¶ï¼ˆæ–¹ä¾¿importï¼‰
__all__ = [
    'StripProcessor',
    'ReplaceProcessor',
    'RegexReplaceProcessor',
    'JoinProcessor',
    'SplitProcessor',
    'ExtractFirstProcessor',
    'ExtractIndexProcessor'
]
```

### 1.4 ä¿®æ”¹ parser.py

åœ¨ `backend/parser.py` é¡¶éƒ¨æ·»åŠ å¯¼å…¥ï¼š

```python
# åœ¨ç°æœ‰å¯¼å…¥åæ·»åŠ 
from backend.plugins.base import PluginRegistry
from backend.plugins import builtin  # è‡ªåŠ¨æ³¨å†Œæ‰€æœ‰å†…ç½®æ’ä»¶
```

æ›¿æ¢ `apply_post_process` æ–¹æ³•ï¼š

```python
def apply_post_process(self, data: Any, processes: List[Dict]) -> Any:
    """
    åº”ç”¨åå¤„ç†ï¼ˆæ’ä»¶åŒ–ç‰ˆæœ¬ï¼‰
    :param data: åŸå§‹æ•°æ®
    :param processes: å¤„ç†æ­¥éª¤åˆ—è¡¨
    :return: å¤„ç†åçš„æ•°æ®
    """
    result = data
    
    for process in processes:
        method = process.get('method', '')
        params = process.get('params', {})
        
        try:
            # ä»æ’ä»¶æ³¨å†Œå™¨è·å–å¤„ç†å™¨
            processor = PluginRegistry.get(method)
            if processor:
                # éªŒè¯å‚æ•°
                if processor.validate_params(params):
                    result = processor.process(result, params)
                else:
                    logger.warning(f"âš ï¸  æ’ä»¶ {method} å‚æ•°éªŒè¯å¤±è´¥: {params}")
            else:
                logger.warning(f"âš ï¸  æœªæ‰¾åˆ°æ¸…æ´—æ’ä»¶: {method}")
        
        except Exception as e:
            logger.warning(f"âš ï¸  æ’ä»¶ {method} å¤„ç†å¤±è´¥: {e}")
    
    return result
```

**å¯é€‰ï¼šä¿ç•™æ—§æ–¹æ³•ä½œä¸ºå¤‡ä»½ï¼ˆæ³¨é‡Šæ‰ï¼‰**

### 1.5 æ·»åŠ APIç«¯ç‚¹

åœ¨ `backend/api.py` æˆ– `backend/routes/crawler.py` æ·»åŠ ï¼š

```python
from backend.plugins.base import PluginRegistry

@app.route('/api/plugins/list', methods=['GET'])
def list_plugins():
    """åˆ—å‡ºæ‰€æœ‰å¯ç”¨æ’ä»¶"""
    try:
        plugins = PluginRegistry.list_all()
        plugin_info = [
            PluginRegistry.get_plugin_info(name) 
            for name in plugins
        ]
        
        return jsonify({
            'success': True,
            'plugins': plugin_info,
            'count': len(plugin_info)
        })
    except Exception as e:
        return jsonify({
            'success': False,
            'error': str(e)
        }), 500


@app.route('/api/plugins/<name>', methods=['GET'])
def get_plugin_info(name):
    """è·å–å•ä¸ªæ’ä»¶è¯¦æƒ…"""
    info = PluginRegistry.get_plugin_info(name)
    if info:
        return jsonify({
            'success': True,
            'plugin': info
        })
    else:
        return jsonify({
            'success': False,
            'error': f'æ’ä»¶ä¸å­˜åœ¨: {name}'
        }), 404
```

### 1.6 æµ‹è¯•éªŒè¯

åˆ›å»º `tests/test_plugin_system.py`ï¼š

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import sys
from pathlib import Path
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from backend.plugins.base import PluginRegistry
from backend.plugins import builtin

def test_plugin_registration():
    """æµ‹è¯•æ’ä»¶æ³¨å†Œ"""
    plugins = PluginRegistry.list_all()
    print(f"âœ… å·²æ³¨å†Œ {len(plugins)} ä¸ªæ’ä»¶:")
    for name in plugins:
        info = PluginRegistry.get_plugin_info(name)
        print(f"   - {name}: {info['description']}")
    
    assert 'strip' in plugins
    assert 'replace' in plugins
    assert 'join' in plugins

def test_strip_plugin():
    """æµ‹è¯•stripæ’ä»¶"""
    processor = PluginRegistry.get('strip')
    assert processor is not None
    
    result = processor.process('  hello  ', {})
    assert result == 'hello'
    print("âœ… stripæ’ä»¶æµ‹è¯•é€šè¿‡")

def test_replace_plugin():
    """æµ‹è¯•replaceæ’ä»¶"""
    processor = PluginRegistry.get('replace')
    assert processor is not None
    
    result = processor.process('hello world', {'old': 'world', 'new': 'python'})
    assert result == 'hello python'
    print("âœ… replaceæ’ä»¶æµ‹è¯•é€šè¿‡")

def test_join_plugin():
    """æµ‹è¯•joinæ’ä»¶"""
    processor = PluginRegistry.get('join')
    assert processor is not None
    
    result = processor.process(['a', 'b', 'c'], {'separator': '-'})
    assert result == 'a-b-c'
    print("âœ… joinæ’ä»¶æµ‹è¯•é€šè¿‡")

if __name__ == '__main__':
    test_plugin_registration()
    test_strip_plugin()
    test_replace_plugin()
    test_join_plugin()
    print("\nğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼")
```

è¿è¡Œæµ‹è¯•ï¼š

```bash
cd /Users/chennan/pythonproject/demo/noval
python tests/test_plugin_system.py
```

### 1.7 éªŒè¯å…¼å®¹æ€§

ä½¿ç”¨ç°æœ‰é…ç½®æµ‹è¯•çˆ¬è™«æ˜¯å¦æ­£å¸¸å·¥ä½œï¼š

```bash
cd /Users/chennan/pythonproject/demo/noval
python -m backend.generic_crawler configs/config_ikbook8.json 9_9810
```

---

## âœ… ç¬¬ä¸€æ­¥å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] æ’ä»¶ç›®å½•ç»“æ„åˆ›å»ºå®Œæˆ
- [ ] `base.py` åˆ›å»ºå®Œæˆ
- [ ] `builtin.py` æ‰€æœ‰å†…ç½®æ’ä»¶è¿ç§»å®Œæˆ
- [ ] `parser.py` ä¿®æ”¹å®Œæˆ
- [ ] APIç«¯ç‚¹æ·»åŠ å®Œæˆ
- [ ] æµ‹è¯•è„šæœ¬é€šè¿‡
- [ ] ç°æœ‰çˆ¬è™«åŠŸèƒ½æ­£å¸¸

**å®Œæˆåï¼Œä½ çš„åç«¯å°±æ‹¥æœ‰äº†å®Œæ•´çš„æ’ä»¶åŒ–èƒ½åŠ›ï¼** ğŸ‰

---

## ğŸ“Œ ç¬¬äºŒæ­¥ï¼šå‰ç«¯åŸºç¡€å‡†å¤‡ï¼ˆæ˜å¤©å¼€å§‹ï¼‰

### 2.1 å®‰è£…ä¾èµ–

```bash
cd /Users/chennan/pythonproject/demo/noval/frontend
npm install reactflow
```

### 2.2 åˆ›å»ºç›®å½•ç»“æ„

```bash
cd src
mkdir -p pages/FlowEditor/nodes
mkdir -p pages/FlowEditor/components
```

### 2.3 åˆ›å»ºåŸºç¡€æ–‡ä»¶

```bash
touch pages/FlowEditor/index.jsx
touch pages/FlowEditor/FlowEditor.css
touch pages/FlowEditor/nodeTypes.js
touch pages/FlowEditor/configGenerator.js
```

**è¯¦ç»†å®ç°è¯·å‚è€ƒã€Šæ’ä»¶åŒ–æµç¨‹ç¼–è¾‘å™¨TODO.mdã€‹**

---

## ğŸ¯ é‡Œç¨‹ç¢‘æ€»è§ˆ

| é˜¶æ®µ | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ | çŠ¶æ€ |
|------|------|----------|------|
| âœ… é˜¶æ®µ1 | åç«¯æ’ä»¶åŒ– | 1å¤© | è¿›è¡Œä¸­ |
| â³ é˜¶æ®µ2 | å‰ç«¯åŸºç¡€ | 2å¤© | å¾…å¼€å§‹ |
| â³ é˜¶æ®µ3 | é…ç½®ç”Ÿæˆ | 2å¤© | å¾…å¼€å§‹ |
| â³ é˜¶æ®µ4 | UIä¼˜åŒ– | 2å¤© | å¾…å¼€å§‹ |
| â³ é˜¶æ®µ5 | è‡ªå®šä¹‰æ’ä»¶ | 2å¤© | å¾…å¼€å§‹ |

---

## ğŸ’¡ å¸¸è§é—®é¢˜

### Q1: æ’ä»¶åŒ–ä¼šå½±å“æ€§èƒ½å—ï¼Ÿ
A: ä¸ä¼šã€‚æ’ä»¶è°ƒç”¨æ˜¯ç›´æ¥çš„æ–¹æ³•è°ƒç”¨ï¼Œæ²¡æœ‰é¢å¤–å¼€é”€ã€‚

### Q2: æ—§é…ç½®è¿˜èƒ½ç”¨å—ï¼Ÿ
A: å®Œå…¨å…¼å®¹ï¼æ’ä»¶åç§°å’ŒåŸæ¥çš„æ–¹æ³•åä¸€è‡´ã€‚

### Q3: å¦‚ä½•æ·»åŠ è‡ªå®šä¹‰æ’ä»¶ï¼Ÿ
A: åˆ›å»ºç±»ç»§æ‰¿ `ProcessorPlugin`ï¼Œç”¨ `@PluginRegistry.register()` è£…é¥°å³å¯ã€‚

### Q4: å‰ç«¯å¯è§†åŒ–ç¼–è¾‘å™¨éš¾å—ï¼Ÿ
A: React Flowå·²ç»å°è£…å¥½äº†ï¼Œä¸»è¦å·¥ä½œæ˜¯é…ç½®èŠ‚ç‚¹ç»„ä»¶ã€‚

---

## ğŸ“š å‚è€ƒèµ„æº

- è¯¦ç»†TODO: `docs/æ’ä»¶åŒ–æµç¨‹ç¼–è¾‘å™¨TODO.md`
- React Flowæ–‡æ¡£: https://reactflow.dev/
- æ¸…æ´—è§„åˆ™è¯´æ˜: `docs/æ¸…æ´—è§„åˆ™ç»Ÿä¸€è¯´æ˜.md`

---

**ç¥ä½ é¡ºåˆ©ï¼æœ‰é—®é¢˜éšæ—¶é—®æˆ‘ ğŸš€**
